#!/usr/bin/env ruby
require 'erb'
require 'pathname'

app = ARGV[0]
root = ENV['DOKKU_ROOT']
hostname = File.read(File.join(root, app, 'DOMAINS'))
port = File.read(File.join(root, app, 'PORT'))
ssl = File.join(root, app, 'ssl')
use_ssl = File.exists?(File.join(ssl, 'server.crt')) && File.exists?(File.join(ssl, 'server.key'))
template = File.open(File.join(Pathname.new(__FILE__).dirname, 'nginx.conf.erb'), 'rb').read;
result = ERB.new(template).result
File.open(File.join(root, app, 'nginx.conf'), 'w') { |file| file.write(result) }
File.open(File.join(root, app, 'URL'), 'w') { |file| file.write("https://#{hostname.split(" ")[0]}") }
